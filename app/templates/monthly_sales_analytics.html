{% extends "base.html" %}

{% block content %}
  <div class="nfsa">
    <div class="hero" style="margin-bottom:22px">
      <div class="hero-tag">Analytics</div>
      <div class="hero-title">Monthly Sales Analytics</div>
      <div class="hero-sub">Track performance, compare periods, and forecast trends</div>
    </div>

    <div class="filter-bar">
      <span class="flt-h">YEAR</span>
      <select id="filterYear" onchange="applyFilters()" style="width:100px">
        <option value="">All</option>
      </select>
      <div class="filter-sep"></div>
      <span class="flt-h">PERIOD</span>
      <select id="filterMonthFrom" onchange="applyFilters()" style="width:80px">
        <option value="">From</option>
        <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
        <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
        <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
        <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
      </select>
      <span class="arrow">‚Üí</span>
      <select id="filterMonthTo" onchange="applyFilters()" style="width:80px">
        <option value="">To</option>
        <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
        <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
        <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
        <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
      </select>
      <div class="filter-sep"></div>
      <div class="pill-group">
        <button class="pill" onclick="quickPeriod(6,this)">L6M</button>
        <button class="pill active" onclick="quickPeriod(12,this)">L12M</button>
        <button class="pill" onclick="quickPeriod(24,this)">2Y</button>
        <button class="pill" onclick="quickPeriod(36,this)">3Y</button>
        <button class="pill" onclick="quickPeriod(0,this)">All</button>
      </div>
      <div class="filter-spacer"></div>
      <button class="btn btn-ghost btn-sm" onclick="openModal('importModal')">üì• Import</button>
      <button class="btn btn-ghost btn-sm" onclick="doExportExcel()">üì§ Excel</button>
      <button class="btn btn-ghost btn-sm" onclick="doExportPDF()">üñ® PDF</button>
      <button class="btn btn-blue btn-sm" onclick="openAdd()">+ Add Record</button>
    </div>

    <div class="section-label">Overview</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-avatar blue">‚Ç®</div>
        <span class="badge badge-blue">Latest</span>
        <div class="kpi-label">Current Month Sales</div>
        <div class="kpi-value" id="k-sales">‚Äî</div>
        <div class="kpi-sub" id="k-period">Loading...</div>
        <div class="kpi-trend trend-flat" id="k-mom-badge">vs prev month</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-avatar green">üèÜ</div>
        <span class="badge badge-green">Best</span>
        <div class="kpi-label">Best Month Ever</div>
        <div class="kpi-value" id="k-best">‚Äî</div>
        <div class="kpi-sub" id="k-best-period">‚Äî</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-avatar" style="font-size:18px">‚àÖ</div>
        <span class="badge badge-gray">Avg</span>
        <div class="kpi-label">Avg Monthly Sales</div>
        <div class="kpi-value" id="k-avg">‚Äî</div>
        <div class="kpi-sub">Across all records</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-avatar amber">üîÆ</div>
        <span class="badge" style="background:var(--amber);color:#000">Forecast</span>
        <div class="kpi-label">Next Month Prediction</div>
        <div class="kpi-value" id="k-predict">‚Äî</div>
        <div class="kpi-sub" id="k-predict-lbl">3-month moving avg</div>
      </div>
    </div>

    <div class="section-label" style="margin-top:8px">Charts</div>
    <div class="charts-grid">
      <div class="chart-card chart-full" id="pdfCapture">
        <div class="chart-header">
          <div>
            <div class="chart-title">Monthly Sales Trend</div>
            <div class="chart-subtitle">Historical performance + 3-month prediction</div>
          </div>
          <div class="chart-actions">
            <button class="btn btn-ghost btn-sm" onclick="dlChart('trendChart','sales_trend')">‚¨á PNG</button>
          </div>
        </div>
        <canvas id="trendChart"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Year-over-Year</div>
            <div class="chart-subtitle">Monthly breakdown by year</div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="dlChart('yearlyChart','yearly')">‚¨á</button>
        </div>
        <canvas id="yearlyChart"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Source Split</div>
            <div class="chart-subtitle">Manual override vs auto-calculated</div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="dlChart('catChart','split')">‚¨á</button>
        </div>
        <canvas id="catChart"></canvas>
        <div class="cat-legend" id="catLegend"></div>
      </div>
    </div>

    <div class="section-label">Comparison Tools</div>
    <div class="filter-bar" style="margin-bottom:14px">
      <span class="flt-h">COMPARE</span>
      <select id="cmpYear" style="width:90px">
        <option value="">Year</option>
      </select>
      <select id="cmpMonth" style="width:110px">
        <option value="">Month</option>
        <option value="1">January</option><option value="2">February</option>
        <option value="3">March</option><option value="4">April</option>
        <option value="5">May</option><option value="6">June</option>
        <option value="7">July</option><option value="8">August</option>
        <option value="9">September</option><option value="10">October</option>
        <option value="11">November</option><option value="12">December</option>
      </select>
      <button class="btn btn-blue btn-sm" onclick="runCompare()">Compare</button>
    </div>
    <div class="compare-grid">
      <div class="compare-card" id="momCard">
        <div class="compare-title">üìÖ Month vs Previous Month</div>
        <div class="muted">Select year and month above, then click Compare.</div>
      </div>
      <div class="compare-card" id="yoyCard">
        <div class="compare-title">üìÜ Month vs Same Month Last Year</div>
        <div class="muted">Select year and month above, then click Compare.</div>
      </div>
    </div>

    <div class="filter-bar" style="margin-bottom:14px">
      <span class="flt-h">MONTH ACROSS YEARS</span>
      <select id="cmpMonthAcross" style="width:160px" onchange="loadMonthAcrossYears()">
        <option value="">Select month</option>
        <option value="1">January</option><option value="2">February</option>
        <option value="3">March</option><option value="4">April</option>
        <option value="5">May</option><option value="6">June</option>
        <option value="7">July</option><option value="8">August</option>
        <option value="9">September</option><option value="10">October</option>
        <option value="11">November</option><option value="12">December</option>
      </select>
    </div>
    <div class="chart-card" style="margin-bottom:20px">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="moyTitle">Month Comparison (across years)</div>
          <div class="chart-subtitle">Compare the same month over multiple years</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="dlChart('monthAcrossChart','month_across_years')">‚¨á</button>
      </div>
      <canvas id="monthAcrossChart"></canvas>
    </div>

    <div class="section-label">Records</div>
    <div class="table-card">
      <div class="table-header">
        <span class="table-title">All Monthly Sales Records</span>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost btn-sm" onclick="refreshAll()">üîÑ Refresh</button>
          <button class="btn btn-blue btn-sm" onclick="openAdd()">+ Add</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Period</th>
            <th>Total Sales</th>
            <th>Bills</th>
            <th>MoM %</th>
            <th>YoY %</th>
            <th>YTD Total</th>
            <th>Source</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="recTable">
          <tr><td colspan="8"><div class="loading"><div class="spin"></div> Loading...</div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="overlay" id="addModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('addModal')">‚úï</button>
      <div class="modal-title" id="addTitle">Add Sales Record</div>
      <div class="modal-sub" id="addSub">Enter monthly data manually. This will override auto-calculated data for the same month.</div>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Year *</label>
          <input type="number" id="f-year" placeholder="2024" min="2000" max="2100" />
        </div>
        <div class="form-group">
          <label class="form-label">Month *</label>
          <select id="f-month">
            <option value="">Select month</option>
            <option value="1">January</option><option value="2">February</option>
            <option value="3">March</option><option value="4">April</option>
            <option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option>
            <option value="9">September</option><option value="10">October</option>
            <option value="11">November</option><option value="12">December</option>
          </select>
        </div>
        <div class="form-group full">
          <label class="form-label">Total Sales Amount (Rs.) *</label>
          <input type="number" id="f-sales" placeholder="e.g. 1500000" min="0" step="1" />
        </div>
        <div class="form-group">
          <label class="form-label">Total Bills (optional)</label>
          <input type="number" id="f-bills" placeholder="e.g. 250" min="0" />
        </div>
        <div class="form-group">
          <label class="form-label">&nbsp;</label>
        </div>
        <div class="form-group full">
          <label class="form-label">Notes</label>
          <textarea id="f-notes" rows="2" placeholder="Optional notes..."></textarea>
        </div>
      </div>
      <div class="form-error" id="addErr"></div>
      <div class="form-footer">
        <button class="btn btn-ghost" onclick="closeModal('addModal')">Cancel</button>
        <button class="btn btn-blue" onclick="submitAdd()" id="addBtn">Save Record</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="importModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('importModal')">‚úï</button>
      <div class="modal-title">Import Sales Data</div>
      <div class="modal-sub">Upload CSV or Excel ‚Äî imported rows become manual overrides.</div>
      <div class="drop-zone" id="dropZone" onclick="document.getElementById('impFile').click()">
        <div class="dz-icon">üìÇ</div>
        <div class="dz-text">Click or drag & drop a file</div>
        <div class="dz-sub">Accepts .csv and .xlsx</div>
      </div>
      <input type="file" id="impFile" accept=".csv,.xlsx,.xls" style="display:none" onchange="pickFile(this)" />
      <div id="impFileInfo" style="display:none" class="info-inline"></div>
      <div class="info-box">
        <strong>Required columns:</strong>
        <code class="code-inline">year, month, total_sales</code>
        | Optional: <code class="code-inline">total_bills, notes</code>
        <div style="margin-top:8px">
          <button class="btn btn-ghost btn-sm" onclick="dlTemplate()">‚¨á Download CSV Template</button>
        </div>
      </div>
      <div id="impResult" style="display:none" class="imp-result"></div>
      <div class="form-footer">
        <button class="btn btn-ghost" onclick="closeModal('importModal')">Cancel</button>
        <button class="btn btn-blue" onclick="submitImport()" id="impBtn">Upload & Import</button>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>
{% endblock %}

{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    .nfsa { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; }
    .nfsa {
      --bg:          var(--bs-body-bg);
      --bg-card:     color-mix(in srgb, var(--bs-body-bg) 78%, transparent);
      --bg-card-2:   color-mix(in srgb, var(--bs-body-bg) 88%, transparent);
      --bg-input:    color-mix(in srgb, var(--bs-body-bg) 92%, transparent);
      --border:      color-mix(in srgb, var(--bs-border-color) 75%, transparent);
      --border-card: color-mix(in srgb, var(--bs-border-color) 70%, transparent);

      --blue:        var(--bs-primary);
      --blue-hover:  color-mix(in srgb, var(--bs-primary) 85%, #000);
      --blue-dim:    color-mix(in srgb, var(--bs-primary) 18%, transparent);
      --green:       var(--bs-success);
      --green-dim:   color-mix(in srgb, var(--bs-success) 18%, transparent);
      --red:         var(--bs-danger);
      --red-dim:     color-mix(in srgb, var(--bs-danger) 18%, transparent);
      --amber:       var(--bs-warning);

      --text-1: var(--bs-body-color);
      --text-2: color-mix(in srgb, var(--bs-body-color) 70%, transparent);
      --text-3: color-mix(in srgb, var(--bs-body-color) 55%, transparent);
      --radius-card: 14px;
      --radius-sm:   8px;
      --radius-pill: 999px;
      --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 16px rgba(0,0,0,0.2);
    }

    .nfsa { color: var(--text-1); }

    .hero { background: var(--bg-card); border: 1px solid var(--border-card); border-radius: var(--radius-card); padding: 32px 36px; position: relative; overflow: hidden; }
    .hero::after { content: ''; position: absolute; top:0; right:0; bottom:0; width: 40%; background: radial-gradient(ellipse at right center, rgba(59,130,246,0.08) 0%, transparent 70%); pointer-events:none; }
    .hero-tag { display:inline-block; background: var(--bg-card-2); border: 1px solid var(--border); border-radius: var(--radius-pill); padding: 4px 14px; font-size: 13px; color: var(--text-2); margin-bottom: 12px; }
    .hero-title { font-size: 28px; font-weight: 700; color: var(--text-1); margin-bottom: 6px; line-height: 1.2; }
    .hero-sub { font-size: 14px; color: var(--text-2); }

    .section-label { font-size: 13px; font-weight: 600; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 14px; }

    .filter-bar { background: var(--bg-card); border: 1px solid var(--border-card); border-radius: var(--radius-card); padding: 14px 18px; display:flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 20px; }
    .flt-h { font-size:12px; color: var(--text-3); font-weight: 600; }
    .filter-sep { width: 1px; height: 24px; background: var(--border); margin: 0 4px; }
    .filter-spacer { flex:1; }
    .arrow { color: var(--text-3); font-size: 13px; }

    select, input[type="number"], input[type="text"], textarea { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-1); border-radius: var(--radius-sm); padding: 7px 11px; font-size: 13px; outline: none; transition: border-color .2s; }
    select:focus, input:focus, textarea:focus { border-color: var(--blue); }

    .pill-group { display:flex; gap: 6px; }
    .pill { padding: 5px 13px; border-radius: var(--radius-pill); font-size: 12px; font-weight: 500; border: 1px solid var(--border); background: transparent; color: var(--text-2); cursor: pointer; transition: all .18s; }
    .pill:hover { border-color: var(--blue); color: var(--blue); }
    .pill.active { background: var(--blue); border-color: var(--blue); color: #fff; }

    .btn { display:inline-flex; align-items:center; gap: 6px; padding: 8px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; cursor:pointer; border: none; transition: all .18s; }
    .btn-blue { background: var(--blue); color: #fff; }
    .btn-blue:hover { background: var(--blue-hover); }
    .btn-ghost { background: var(--bg-card-2); border: 1px solid var(--border); color: var(--text-2); }
    .btn-ghost:hover { color: var(--text-1); border-color: rgba(255,255,255,0.15); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .kpi-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
    .kpi-card { background: var(--bg-card); border: 1px solid var(--border-card); border-radius: var(--radius-card); padding: 20px 22px; position: relative; }
    .kpi-avatar { width: 38px; height: 38px; background: var(--bg-card-2); border: 1px solid var(--border); border-radius: 10px; display:flex; align-items:center; justify-content:center; font-size: 14px; font-weight: 700; color: var(--text-2); margin-bottom: 14px; }
    .kpi-avatar.blue  { background: var(--blue-dim);  border-color: rgba(59,130,246,0.2);  color: var(--blue); }
    .kpi-avatar.green { background: var(--green-dim); border-color: rgba(34,197,94,0.2);   color: var(--green); }
    .kpi-avatar.red   { background: var(--red-dim);   border-color: rgba(239,68,68,0.2);   color: var(--red); }
    .kpi-avatar.amber { background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.2); color: var(--amber); }

    .badge { position:absolute; top: 18px; right: 18px; padding: 3px 10px; border-radius: var(--radius-pill); font-size: 11px; font-weight: 600; }
    .badge-blue  { background: var(--blue); color: #fff; }
    .badge-green { background: var(--green); color: #fff; }
    .badge-gray  { background: var(--bg-input); color: var(--text-2); }

    .kpi-label { font-size: 13px; color: var(--text-2); margin-bottom: 6px; }
    .kpi-value { font-size: 22px; font-weight: 700; color: var(--text-1); line-height: 1.2; margin-bottom: 4px; }
    .kpi-sub { font-size: 12px; color: var(--text-3); }

    .kpi-trend { display:inline-flex; align-items:center; gap: 3px; font-size: 12px; font-weight: 600; padding: 2px 8px; border-radius: var(--radius-pill); margin-top: 8px; }
    .trend-up { background: var(--green-dim); color: var(--green); }
    .trend-down { background: var(--red-dim); color: var(--red); }
    .trend-flat { background: var(--bg-input); color: var(--text-3); }

    .charts-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
    .chart-full { grid-column: 1 / -1; }
    .chart-card { background: var(--bg-card); border: 1px solid var(--border-card); border-radius: var(--radius-card); padding: 22px 24px; }
    .chart-header { display:flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .chart-title { font-size: 15px; font-weight: 600; color: var(--text-1); }
    .chart-subtitle { font-size: 12px; color: var(--text-3); margin-top: 2px; }

    canvas { width: 100% !important; }
    .chart-full canvas { max-height: 300px; }
    .chart-card:not(.chart-full) canvas { max-height: 260px; }

    .compare-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
    .compare-card { background: var(--bg-card); border: 1px solid var(--border-card); border-radius: var(--radius-card); padding: 22px 24px; }
    .compare-title { font-size: 14px; font-weight: 600; color: var(--text-2); margin-bottom: 16px; display:flex; align-items:center; gap: 8px; }
    .compare-row { display:flex; justify-content: space-between; align-items:center; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .compare-row:last-child { border-bottom:none; padding-bottom:0; }
    .compare-lbl { font-size: 12px; color: var(--text-3); margin-bottom: 2px; }
    .compare-val { font-size: 15px; font-weight: 600; color: var(--text-1); }
    .compare-chip { padding: 4px 12px; border-radius: var(--radius-pill); font-size: 12px; font-weight: 600; }
    .chip-up { background: var(--green-dim); color: var(--green); }
    .chip-down { background: var(--red-dim); color: var(--red); }

    .table-card { background: var(--bg-card); border: 1px solid var(--border-card); border-radius: var(--radius-card); overflow:hidden; }
    .table-header { display:flex; justify-content: space-between; align-items:center; padding: 18px 22px; border-bottom: 1px solid var(--border); }
    .table-title { font-size: 15px; font-weight: 600; }

    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--bg-card-2); }
    th { padding: 11px 16px; text-align:left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-3); white-space: nowrap; }
    td { padding: 12px 16px; font-size: 13px; border-top: 1px solid var(--border); vertical-align: middle; }

    .source-tag { display:inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; background: var(--bg-input); color: var(--text-3); border: 1px solid var(--border); }
    .growth-pill { display:inline-flex; align-items:center; gap: 2px; padding: 2px 8px; border-radius: var(--radius-pill); font-size: 12px; font-weight: 600; }
    .gp-up { background: var(--green-dim); color: var(--green); }
    .gp-down { background: var(--red-dim); color: var(--red); }
    .gp-nil { color: var(--text-3); font-size: 12px; }

    .edit-btn { padding: 4px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-2); font-size: 12px; cursor:pointer; transition: all .15s; }
    .edit-btn:hover { border-color: var(--blue); color: var(--blue); }

    .overlay { display:none; position: fixed; inset:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 2500; align-items: center; justify-content: center; }
    .overlay.open { display:flex; }

    .modal { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-card); padding: 28px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y:auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .modal-close { position:absolute; top: 16px; right: 16px; width: 30px; height: 30px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-3); display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all .15s; }
    .modal-close:hover { color: var(--red); border-color: var(--red); }

    .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
    .modal-sub { font-size: 13px; color: var(--text-3); margin-bottom: 22px; }

    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-group { display:flex; flex-direction: column; gap: 5px; }
    .form-group.full { grid-column: 1 / -1; }
    .form-label { font-size: 12px; font-weight: 600; color: var(--text-2); }

    .form-error { color: var(--red); font-size: 12px; margin-top: 10px; display:none; }

    .form-footer { display:flex; justify-content: flex-end; gap: 10px; margin-top: 22px; padding-top: 18px; border-top: 1px solid var(--border); }

    .drop-zone { border: 2px dashed var(--border); border-radius: var(--radius-card); padding: 28px; text-align:center; cursor:pointer; transition: all .2s; margin-bottom: 14px; }
    .drop-zone:hover, .drop-zone.over { border-color: var(--blue); background: var(--blue-dim); }
    .dz-icon { font-size: 2rem; margin-bottom: 6px; }
    .dz-text { font-size: 13px; color: var(--text-2); }
    .dz-sub { font-size: 11px; color: var(--text-3); margin-top: 3px; }

    .info-box { background: var(--blue-dim); border: 1px solid rgba(59,130,246,0.2); border-radius: var(--radius-sm); padding: 11px 14px; font-size: 12px; color: var(--text-2); margin-bottom: 14px; }
    .info-box strong { color: var(--blue); }
    .code-inline { font-size: 11px; color: var(--text-2); margin: 0 6px; }
    .info-inline { font-size: 13px; color: var(--blue); margin-bottom: 10px; padding: 10px; background: var(--blue-dim); border-radius: 8px; border: 1px solid rgba(59,130,246,0.2); }
    .imp-result { padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 10px; border: 1px solid var(--border); }

    .toast-wrap { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display:flex; flex-direction: column; gap: 8px; }
    .toast { background: var(--bg-card-2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 18px; min-width: 260px; display:flex; align-items:center; gap: 10px; font-size: 13px; box-shadow: var(--shadow); }
    .toast.ok { border-left: 3px solid var(--green); }
    .toast.err { border-left: 3px solid var(--red); }

    .cat-legend { display:flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; }
    .cat-dot { display:flex; align-items:center; gap: 5px; font-size: 12px; color: var(--text-2); }
    .dot { width: 9px; height: 9px; border-radius: 2px; }

    .loading { display:flex; align-items:center; justify-content:center; padding: 40px; color: var(--text-3); font-size: 13px; gap: 10px; }
    .spin { width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--blue); border-radius: 50%; animation: spin .6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .muted { color: var(--text-3); font-size: 13px; }

    @media (max-width: 1024px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .chart-full { grid-column: 1; }
      .compare-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .kpi-grid { grid-template-columns: 1fr 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .hero { padding: 22px; }
    }
    @media (max-width: 420px) {
      .kpi-grid { grid-template-columns: 1fr; }
    }
  </style>

  <script>
    let allRecs = [];
    let periodsShown = 12;
    let chartTrend, chartYearly, chartCat, chartMonthAcross;
    let impFile = null;

    const MN = ['', 'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    Chart.defaults.color       = '#64748b';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
    Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif";
    Chart.defaults.font.size   = 11;

    const TT_BASE = {
      backgroundColor: '#252d3d',
      borderColor: 'rgba(59,130,246,0.25)',
      borderWidth: 1,
      titleColor: '#3b82f6',
      bodyColor: '#f1f5f9',
      padding: 10,
    };

    function openModal(id)  {
      document.getElementById(id).classList.add('open');
      document.body.classList.add('modal-open');
    }
    function closeModal(id) {
      document.getElementById(id).classList.remove('open');
      if (!document.querySelector('.overlay.open')) {
        document.body.classList.remove('modal-open');
      }
      if (id === 'addModal') document.getElementById('addErr').style.display = 'none';
      if (id === 'importModal') {
        impFile = null;
        const f = document.getElementById('impFile');
        if (f) f.value = '';
        document.getElementById('impFileInfo').style.display = 'none';
        document.getElementById('impResult').style.display = 'none';
      }
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') document.querySelectorAll('.overlay.open').forEach(m => closeModal(m.id));
    });
    document.addEventListener('click', e => {
      const o = e.target;
      if (o && o.classList && o.classList.contains('overlay') && o.classList.contains('open')) closeModal(o.id);
    });

    function toast(type, msg) {
      const wrap = document.getElementById('toastWrap');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<span>${type === 'ok' ? '‚úÖ' : '‚ùå'}</span><span>${escapeHtml(msg)}</span>`;
      wrap.appendChild(t);
      setTimeout(() => t.remove(), 3500);
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }

    function fmtRs(n) {
      const v = Number(n || 0);
      if (!v) return '‚Äî';
      if (v >= 10000000) return `Rs. ${(v / 10000000).toFixed(2)}Cr`;
      if (v >= 100000) return `Rs. ${(v / 100000).toFixed(1)}L`;
      return `Rs. ${Math.round(v).toLocaleString()}`;
    }

    function compact(n) {
      const v = Number(n || 0);
      if (v >= 10000000) return (v / 10000000).toFixed(1) + 'Cr';
      if (v >= 100000) return (v / 100000).toFixed(1) + 'L';
      if (v >= 1000) return (v / 1000).toFixed(0) + 'K';
      return String(v);
    }

    function gPill(v) {
      if (v === null || v === undefined) return `<span class="gp-nil">‚Äî</span>`;
      const num = Number(v);
      if (!isFinite(num)) return `<span class="gp-nil">‚Äî</span>`;
      const up = num >= 0;
      return `<span class="growth-pill ${up ? 'gp-up' : 'gp-down'}">${up ? '‚ñ≤' : '‚ñº'} ${Math.abs(num).toFixed(1)}%</span>`;
    }

    function quickPeriod(n, btn) {
      periodsShown = n;
      document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      refreshAll();
    }

    function applyFilters() { refreshAll(); }

    function getFilterParams() {
      const y = document.getElementById('filterYear').value;
      const mf = document.getElementById('filterMonthFrom').value;
      const mt = document.getElementById('filterMonthTo').value;
      const p = new URLSearchParams();
      if (y) p.set('year', y);
      if (mf) p.set('month_from', mf);
      if (mt) p.set('month_to', mt);
      if (periodsShown) p.set('last_n', String(periodsShown));
      return p;
    }

    async function fetchData() {
      const params = getFilterParams();
      const res = await fetch('/monthly-sales/api/records?' + params.toString());
      if (!res.ok) throw new Error('Failed to load');
      return await res.json();
    }

    function setText(id, v) { const el = document.getElementById(id); if (el) el.textContent = v; }

    function ensureYearOptions(years) {
      const ySel = document.getElementById('filterYear');
      const cSel = document.getElementById('cmpYear');
      const current = ySel.value;

      function fill(sel, keep) {
        const base = sel.id === 'filterYear' ? '<option value="">All</option>' : '<option value="">Year</option>';
        sel.innerHTML = base;
        (years || []).slice().sort((a,b)=>b-a).forEach(y => {
          const o = document.createElement('option');
          o.value = String(y);
          o.textContent = String(y);
          sel.appendChild(o);
        });
        if (keep) sel.value = keep;
      }

      fill(ySel, current);
      fill(cSel, cSel.value);
    }

    function loadKPIs(summary) {
      const latest = summary.latest;
      const best = summary.best;
      setText('k-sales', latest ? fmtRs(latest.total_sales_pkr) : '‚Äî');
      setText('k-period', latest ? latest.period : 'No data');
      setText('k-best', best ? fmtRs(best.total_sales_pkr) : '‚Äî');
      setText('k-best-period', best ? best.period : '‚Äî');
      setText('k-avg', summary.avg ? fmtRs(summary.avg) : '‚Äî');

      const pred = summary.prediction;
      if (pred) {
        setText('k-predict', fmtRs(pred));
        if (latest) {
          const m = Number(latest.month || 0);
          const y = Number(latest.year || 0);
          const pm = m === 12 ? 1 : (m + 1);
          const py = m === 12 ? (y + 1) : y;
          setText('k-predict-lbl', `${MN[pm]} ${py} estimate`);
        } else {
          setText('k-predict-lbl', '3-month moving avg');
        }
      } else {
        setText('k-predict', '‚Äî');
        setText('k-predict-lbl', 'Need at least 3 months');
      }

      const momEl = document.getElementById('k-mom-badge');
      if (momEl && latest && latest.mom_growth !== null && latest.mom_growth !== undefined) {
        const up = Number(latest.mom_growth) >= 0;
        momEl.textContent = `${up ? '‚ñ≤' : '‚ñº'} ${Math.abs(Number(latest.mom_growth)).toFixed(1)}% vs prev month`;
        momEl.className = `kpi-trend ${up ? 'trend-up' : 'trend-down'}`;
      } else if (momEl) {
        momEl.textContent = 'vs prev month';
        momEl.className = 'kpi-trend trend-flat';
      }
    }

    function loadTrend() {
      const recs = periodsShown ? allRecs.slice(-periodsShown) : allRecs;
      const labels = recs.map(r => r.period);
      const data = recs.map(r => Number(r.total_sales_pkr || 0));

      let pred = null;
      if (allRecs.length >= 3) {
        const last3 = allRecs.slice(-3).map(r => Number(r.total_sales_pkr || 0));
        pred = Math.round((last3[0] + last3[1] + last3[2]) / 3);
      }

      if (pred !== null) {
        const latest = allRecs[allRecs.length - 1];
        const m = Number(latest.month || 0);
        const y = Number(latest.year || 0);
        const pm = m === 12 ? 1 : (m + 1);
        const py = m === 12 ? (y + 1) : y;
        labels.push(`${MN[pm]}-${py} ‚ú¶`);
        data.push(pred);
      }

      const ctx = document.getElementById('trendChart');
      const gradient = (() => {
        const g = ctx.getContext('2d').createLinearGradient(0,0,0,300);
        g.addColorStop(0, 'rgba(59,130,246,0.18)');
        g.addColorStop(1, 'rgba(59,130,246,0)');
        return g;
      })();

      const cfg = {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data,
            borderColor: '#3b82f6',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: { ...TT_BASE, callbacks: { label: c => ` Rs. ${Number(c.parsed.y||0).toLocaleString()}` } }
          },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { maxTicksLimit: 12, maxRotation: 45 } },
            y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { callback: v => 'Rs ' + compact(v) } }
          }
        }
      };

      if (chartTrend) { chartTrend.data = cfg.data; chartTrend.update(); }
      else { chartTrend = new Chart(ctx, cfg); }
    }

    function loadYearly() {
      const years = [...new Set(allRecs.map(r => Number(r.year)))].sort((a,b)=>a-b);
      const cols = ['#3b82f6','#6366f1','#22c55e','#f59e0b'];
      const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

      const datasets = years.map((y,i)=>({
        label: String(y),
        data: labels.map((_, mi) => {
          const r = allRecs.find(x => Number(x.year) === y && Number(x.month) === mi+1);
          return r ? Number(r.total_sales_pkr || 0) : 0;
        }),
        backgroundColor: cols[i % cols.length] + 'BB',
        borderRadius: 3,
      }));

      const cfg = {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: true, labels: { color: '#94a3b8', usePointStyle: true, padding: 14 } },
            tooltip: { ...TT_BASE, callbacks: { label: c => ` ${c.dataset.label}: Rs ${Number(c.parsed.y||0).toLocaleString()}` } }
          },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.04)' } },
            y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { callback: v => 'Rs ' + compact(v) } }
          }
        }
      };

      const el = document.getElementById('yearlyChart');
      if (chartYearly) { chartYearly.data = cfg.data; chartYearly.update(); }
      else { chartYearly = new Chart(el, cfg); }
    }

    function loadSplit() {
      let manual = 0;
      let auto = 0;
      for (const r of allRecs) {
        const v = Number(r.total_sales_pkr || 0);
        if (String(r.source || '') === 'manual') manual += v; else auto += v;
      }

      const labels = ['Manual (override)', 'Auto (from transactions)'];
      const values = [manual, auto];
      const colors = ['#3b82f6', '#22c55e'];

      const cfg = {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{ data: values, backgroundColor: colors, borderColor: '#1e2535', borderWidth: 3, hoverOffset: 6 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '62%',
          plugins: {
            legend: { display: false },
            tooltip: { ...TT_BASE, callbacks: { label: c => ` Rs ${Number(c.parsed||0).toLocaleString()}` } }
          }
        }
      };

      document.getElementById('catLegend').innerHTML = labels.map((l,i)=>
        `<div class="cat-dot"><div class="dot" style="background:${colors[i]}"></div>${l}</div>`
      ).join('');

      const el = document.getElementById('catChart');
      if (chartCat) { chartCat.data = cfg.data; chartCat.update(); }
      else { chartCat = new Chart(el, cfg); }
    }

    function loadMonthAcrossYears() {
      const m = Number(document.getElementById('cmpMonthAcross').value || 0);
      const title = document.getElementById('moyTitle');
      if (!m) {
        if (title) title.textContent = 'Month Comparison (across years)';
        const el = document.getElementById('monthAcrossChart');
        if (chartMonthAcross) {
          chartMonthAcross.data = { labels: [], datasets: [{ data: [] }] };
          chartMonthAcross.update();
        } else {
          chartMonthAcross = new Chart(el, { type: 'bar', data: { labels: [], datasets: [{ data: [] }] }, options: { responsive: true } });
        }
        return;
      }

      const rows = allRecs.filter(r => Number(r.month) === m).sort((a,b) => Number(a.year) - Number(b.year));
      const labels = rows.map(r => String(r.year));
      const data = rows.map(r => Number(r.total_sales_pkr || 0));
      if (title) title.textContent = `${MN[m]} (across years)`;

      const cfg = {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: `Sales in ${MN[m]}`,
            data,
            backgroundColor: 'rgba(13,110,253,0.55)',
            borderRadius: 4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: { ...TT_BASE, callbacks: { label: c => ` Rs ${Number(c.parsed.y||0).toLocaleString()}` } }
          },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.04)' } },
            y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { callback: v => 'Rs ' + compact(v) } }
          }
        }
      };

      const el = document.getElementById('monthAcrossChart');
      if (chartMonthAcross) { chartMonthAcross.data = cfg.data; chartMonthAcross.update(); }
      else { chartMonthAcross = new Chart(el, cfg); }
    }

    function loadTable() {
      const tbody = document.getElementById('recTable');
      if (!allRecs.length) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="loading">No records found</div></td></tr>`;
        return;
      }

      const show = periodsShown ? allRecs.slice(-periodsShown) : allRecs;
      tbody.innerHTML = [...show].reverse().map(r => {
        const src = String(r.source || 'auto');
        const edit = src === 'manual'
          ? `<button class="edit-btn" onclick="openEdit(${Number(r.year)},${Number(r.month)})">Edit</button>`
          : `<button class="edit-btn" onclick="openOverride(${Number(r.year)},${Number(r.month)})">Override</button>`;

        return `
          <tr>
            <td><strong style="color:var(--text-1)">${escapeHtml(r.period)}</strong></td>
            <td>Rs. ${Number(r.total_sales_pkr || 0).toLocaleString()}</td>
            <td style="color:var(--text-3)">${r.total_bills === null || r.total_bills === undefined ? '‚Äî' : escapeHtml(r.total_bills)}</td>
            <td>${gPill(r.mom_growth)}</td>
            <td>${gPill(r.yoy_growth)}</td>
            <td style="color:var(--text-3);font-size:12px">${r.ytd_total ? 'Rs ' + compact(r.ytd_total) : '‚Äî'}</td>
            <td><span class="source-tag">${escapeHtml(src)}</span></td>
            <td>${edit}</td>
          </tr>`;
      }).join('');
    }

    async function refreshAll() {
      try {
        const data = await fetchData();
        allRecs = (data.records || []).map(r => ({
          ...r,
          year: Number(r.year),
          month: Number(r.month),
        }));

        ensureYearOptions(data.summary ? data.summary.years : []);
        loadKPIs(data.summary || {});

        loadTrend();
        loadYearly();
        loadSplit();
        loadMonthAcrossYears();
        loadTable();
      } catch (e) {
        toast('err', 'Failed to load monthly sales');
        const tbody = document.getElementById('recTable');
        if (tbody) tbody.innerHTML = `<tr><td colspan="8"><div class="loading">Failed to load</div></td></tr>`;
      }
    }

    function openAdd() {
      const now = new Date();
      document.getElementById('f-year').value = String(now.getFullYear());
      document.getElementById('f-month').value = '';
      document.getElementById('f-sales').value = '';
      document.getElementById('f-bills').value = '';
      document.getElementById('f-notes').value = '';
      openModal('addModal');
    }

    function openEdit(year, month) {
      const r = allRecs.find(x => Number(x.year) === Number(year) && Number(x.month) === Number(month));
      if (!r || String(r.source) !== 'manual') {
        openOverride(year, month);
        return;
      }
      document.getElementById('f-year').value = String(year);
      document.getElementById('f-month').value = String(month);
      document.getElementById('f-sales').value = String(Number(r.total_sales_pkr || 0));
      document.getElementById('f-bills').value = r.total_bills === null || r.total_bills === undefined ? '' : String(r.total_bills);
      document.getElementById('f-notes').value = r.notes || '';
      openModal('addModal');
    }

    function openOverride(year, month) {
      const r = allRecs.find(x => Number(x.year) === Number(year) && Number(x.month) === Number(month));
      document.getElementById('f-year').value = String(year);
      document.getElementById('f-month').value = String(month);
      document.getElementById('f-sales').value = r ? String(Number(r.total_sales_pkr || 0)) : '';
      document.getElementById('f-bills').value = r && r.total_bills ? String(r.total_bills) : '';
      document.getElementById('f-notes').value = '';
      openModal('addModal');
    }

    async function submitAdd() {
      const year = Number(document.getElementById('f-year').value || 0);
      const month = Number(document.getElementById('f-month').value || 0);
      const sales = Number(document.getElementById('f-sales').value || 0);
      const billsRaw = document.getElementById('f-bills').value;
      const notes = document.getElementById('f-notes').value;

      const err = document.getElementById('addErr');
      err.style.display = 'none';

      if (!year || !month || !sales) {
        err.textContent = 'Year, month and total sales are required.';
        err.style.display = 'block';
        return;
      }

      const fd = new FormData();
      fd.set('year', String(year));
      fd.set('month', String(month));
      fd.set('total_sales_pkr', String(Math.round(sales)));
      if (billsRaw && String(billsRaw).trim() !== '') fd.set('total_bills', String(billsRaw));
      if (notes && String(notes).trim() !== '') fd.set('notes', String(notes));

      const res = await fetch('/monthly-sales/api/manual/upsert', { method: 'POST', body: fd });
      if (!res.ok) {
        const j = await res.json().catch(() => null);
        err.textContent = (j && j.detail) ? String(j.detail) : 'Failed to save.';
        err.style.display = 'block';
        return;
      }

      closeModal('addModal');
      toast('ok', `Saved override for ${MN[month]} ${year}`);
      await refreshAll();
    }

    function pickFile(input) {
      impFile = input.files[0];
      if (!impFile) return;
      const info = document.getElementById('impFileInfo');
      info.style.display = 'block';
      info.textContent = `üìé ${impFile.name} (${(impFile.size/1024).toFixed(1)} KB)`;
    }

    async function submitImport() {
      if (!impFile) { toast('err', 'Select a file first.'); return; }
      const fd = new FormData();
      fd.set('file', impFile);

      const btn = document.getElementById('impBtn');
      btn.disabled = true;
      btn.textContent = 'Uploading...';

      try {
        const res = await fetch('/monthly-sales/api/import', { method: 'POST', body: fd });
        const j = await res.json().catch(() => null);
        if (!res.ok) {
          toast('err', (j && j.detail) ? String(j.detail) : 'Import failed');
          return;
        }
        const result = document.getElementById('impResult');
        result.style.display = 'block';
        result.style.background = 'var(--green-dim)';
        result.textContent = `‚úì Imported. Created ${j.created || 0}, updated ${j.updated || 0}, skipped ${j.skipped || 0}.`;
        toast('ok', 'Import completed');
        await refreshAll();
        setTimeout(() => closeModal('importModal'), 800);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Upload & Import';
      }
    }

    function dlTemplate() {
      const csv = `year,month,total_sales,total_bills,notes\n2024,1,1250000,210,January 2024\n2024,2,980000,175,\n2024,3,1450000,240,`;
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = 'nusrat_sales_template.csv';
      a.click();
    }

    function dlChart(id, name) {
      const el = document.getElementById(id);
      const a = document.createElement('a');
      a.download = `${name}.png`;
      a.href = el.toDataURL('image/png');
      a.click();
      toast('ok', 'Chart downloaded');
    }

    function doExportExcel() {
      if (typeof XLSX === 'undefined') { toast('err', 'Excel export unavailable'); return; }
      const rows = allRecs;
      const ws = XLSX.utils.aoa_to_sheet([
        ['Period','Year','Month','Total Sales (Rs.)','Bills','MoM %','YoY %','YTD Total','Source','Notes'],
        ...rows.map(r => [r.period, r.year, r.month, Number(r.total_sales_pkr || 0), r.total_bills ?? '', r.mom_growth ?? '', r.yoy_growth ?? '', r.ytd_total ?? '', r.source ?? '', r.notes ?? ''])
      ]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Monthly Sales');
      XLSX.writeFile(wb, 'monthly_sales.xlsx');
      toast('ok', 'Excel exported');
    }

    async function doExportPDF() {
      try {
        const { jsPDF } = window.jspdf || jspdf;
        toast('ok', 'Generating PDF...');
        const canvas = await html2canvas(document.getElementById('pdfCapture'), { backgroundColor: '#161b27', scale: 1.2 });
        const pdf = new jsPDF('l','mm','a4');
        const w = pdf.internal.pageSize.getWidth();
        const h = (canvas.height * w) / canvas.width;
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, w, Math.min(h, 200));
        pdf.save('monthly_sales_report.pdf');
      } catch (e) {
        toast('err', 'PDF export failed');
      }
    }

    function renderCmp(title, curr, prev) {
      if (!prev) return `<div class="compare-title">${escapeHtml(title)}</div><div class="muted">No prior record found.</div>`;
      const diff = Number(curr.total_sales_pkr||0) - Number(prev.total_sales_pkr||0);
      const pct = prev.total_sales_pkr ? (diff / Number(prev.total_sales_pkr||1) * 100) : 0;
      const up = diff >= 0;
      return `
        <div class="compare-title">${escapeHtml(title)}</div>
        <div class="compare-row">
          <div><div class="compare-lbl">Current</div><div class="compare-val">${escapeHtml(curr.period)}</div></div>
          <div style="font-weight:700;color:var(--text-1)">Rs. ${Number(curr.total_sales_pkr||0).toLocaleString()}</div>
        </div>
        <div class="compare-row">
          <div><div class="compare-lbl">Previous</div><div class="compare-val">${escapeHtml(prev.period)}</div></div>
          <div style="color:var(--text-2)">Rs. ${Number(prev.total_sales_pkr||0).toLocaleString()}</div>
        </div>
        <div class="compare-row">
          <div class="compare-lbl">Difference</div>
          <span class="compare-chip ${up ? 'chip-up' : 'chip-down'}">${up ? '‚ñ≤' : '‚ñº'} ${Math.abs(pct).toFixed(1)}% &nbsp; Rs. ${Math.abs(diff).toLocaleString()}</span>
        </div>`;
    }

    function runCompare() {
      const y = Number(document.getElementById('cmpYear').value || 0);
      const m = Number(document.getElementById('cmpMonth').value || 0);
      if (!y || !m) { toast('err', 'Select both year and month'); return; }
      const curr = allRecs.find(r => Number(r.year) === y && Number(r.month) === m);
      if (!curr) { toast('err', 'No record for that period'); return; }

      const pm = m === 1 ? 12 : (m - 1);
      const py = m === 1 ? (y - 1) : y;
      const prev = allRecs.find(r => Number(r.year) === py && Number(r.month) === pm);
      document.getElementById('momCard').innerHTML = renderCmp('üìÖ Month vs Previous Month', curr, prev);

      const ly = allRecs.find(r => Number(r.year) === (y - 1) && Number(r.month) === m);
      document.getElementById('yoyCard').innerHTML = renderCmp('üìÜ Month vs Same Month Last Year', curr, ly);
    }

    (function initDrop() {
      const dz = document.getElementById('dropZone');
      if (!dz) return;
      dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
      dz.addEventListener('dragleave', () => dz.classList.remove('over'));
      dz.addEventListener('drop', e => {
        e.preventDefault();
        dz.classList.remove('over');
        const f = e.dataTransfer.files[0];
        if (!f) return;
        impFile = f;
        const info = document.getElementById('impFileInfo');
        info.style.display = 'block';
        info.textContent = `üìé ${f.name} (${(f.size/1024).toFixed(1)} KB)`;
      });
    })();

    window.addEventListener('DOMContentLoaded', () => {
      refreshAll();
    });
  </script>
{% endblock %}
